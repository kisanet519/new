
SELECT TRANAME FROM (
SELECT TRANAME, COUNT(TRANAME) AS CNT_TRA FROM(
SELECT c.* FROM (

SELECT USERID, SESSION, TRANAME,COUNT(TRANAME) TRA_PER_SESSION FROM 
(

SELECT USERID,TRANAME, TS, SUM(DELTA) PARTITION BY (USERID) OVER(ORDER BY TIMESTAMP) AS SESSION FROM

(
SELECT USERID,TRANAME, TIMESTAMP AS TS,
CASE WHEN 
TIMESTAMPDIFF(MINUTE,TIMESTAMP, lead (TIMESTAMP) PARTITION BY (USERID) over (order by TIMESTAMP)) IS BETWEEN 0 AND 20 THEN 0 ELSE 1 END AS TS_DELTA
FROM TABLE_1
ORDER BY USERID, TIMESTAMP 
) A
)B
GROUP BY 1,2
)C
ORDER BY TRA_PER_SESSION DESC
LIMIT 50
)D
GROUP BY 1
)E
ORDER BY CNT_TRA DESC 
LIMIT 10
